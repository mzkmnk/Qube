# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリで作業する際のガイダンスを提供します。

## プロジェクト概要

Qube は Amazon Q CLI のための React ベースの TUI（ターミナルユーザーインターフェース）ラッパーで、TypeScript と Ink フレームワークで構築されています。このプロジェクトは、コマンド履歴、出力ストリーミング、直感的なキーバインディングなどの機能を備えた、Amazon Q CLI のインタラクティブなシェル体験を提供することを目的としています。

## 主要コマンド

### 開発
- `npm run dev` - tsx によるホットリロード付き開発サーバー起動 (src/cli.tsx)
- `npm run build` - TypeScript を dist/ ディレクトリにビルド
- `npm start` - コンパイル済みCLIを dist/cli.js から実行
- `npm test` - Vitest でテスト実行（設定後）

### ビルドプロセス
1. TypeScript コンパイル: `tsc src/cli.tsx --outDir dist`
2. 出力: dist/ ディレクトリに ES modules
3. エントリポイント: dist/cli.js（CLI実行用のshebangが必要）

## アーキテクチャ

### 技術スタック
- **ランタイム**: Node.js 22+ (ES modules)
- **UIフレームワーク**: Ink 6.x + React 19.x（ターミナルレンダリング用）
- **言語**: TypeScript（strict mode有効）
- **ビルドツール**: 開発時は tsx、本番用は tsc

### プロジェクト構造
```
/
├── src/
│   ├── cli.tsx            # メインエントリポイント
│   ├── components/        # UIコンポーネント (Output, Input など)
│   ├── lib/              # ユーティリティ (history, spawn, config)
│   └── types/            # TypeScript型定義
├── tasks/                # 開発タスクドキュメント
└── dist/                # ビルド出力 (gitignore対象)
```

### コアコンポーネント（計画中）
1. **Q CLI 統合** (タスク 03)
   - バイナリ検出: 環境変数 > PATH検索
   - ストリーム処理を伴うプロセス起動
   - タイムアウトと非ゼロ終了のエラーハンドリング

2. **TUI シェル** (タスク 04)
   - タイトル/バージョン付きヘッダー
   - スクロール可能な出力パネル
   - 履歴付きコマンド入力
   - ステータスバー
   - キーバインド: Enter（実行）、Ctrl+C（終了）、Ctrl+L（クリア）、↑↓（履歴）

3. **ストリーム処理** (タスク 05)
   - ANSIエスケープシーケンス処理
   - JSON/Markdown解析
   - リアルタイム出力レンダリング

## 開発ガイドライン

### 言語ポリシー
- **コードのコメントは日本語で記載すること**
- ドキュメント、テスト名、変数の説明は日本語を推奨
- コミットメッセージは英語推奨、日本語も可（チームで統一）
- PRには要点の簡潔な英訳を併記

### t-waga推奨のTDD実践方法

#### 基本原則
- **Red → Green → Refactor サイクルを徹底**
  1. Red: まず失敗するテストを書く
  2. Green: テストを通す最小限の実装を行う
  3. Refactor: コードを整理・改善する

#### 実践ルール
- **振る舞い駆動**: 外部挙動（入出力・副作用）をテストし、内部実装詳細に依存しない
- **優先順位**: プロセス間通信、例外系（`child_process.spawn`、タイムアウト、非ゼロ終了）を最優先でテスト
- **小さなステップ**: 各ステップで必ずコミット（テスト追加、実装、リファクタリングを分ける）
- **テスト名**: 仕様を短文で記述（日本語推奨）
  - 例: `「Q CLIが見つからない場合、分かりやすいエラーメッセージを表示する」`
  - 例: `「コマンド実行時、標準出力をUIに反映する」`

#### コミット例
```
test: Q CLIバイナリが存在しない場合のテストを追加 (Red)
feat: Q CLIバイナリ検出エラーメッセージを実装 (Green)
refactor: エラーメッセージ生成を関数に抽出 (Refactor)
```

### コードスタイル
- TypeScript（ES Modules使用）
- インデント: スペース2つ
- ファイル名: kebab-case
- コンポーネント: PascalCase、関数コンポーネント
- named export を優先
- コンポーネントは小さく、単一責務を保つ

### テスト戦略
- フレームワーク: Vitest（推奨）
- 配置: src/__tests__/ または同階層の *.test.ts(x)
- Ink の入出力はモック化
- 重要処理は ≥80% カバレッジを目標
- フォーカス: spawn処理、ストリーム解析、エラーケース

### テスト作成時の注意点
- 各テストは独立して実行可能にする
- セットアップとクリーンアップを適切に行う
- モックは最小限に留め、可能な限り実際の動作に近いテストを書く
- エッジケースと異常系を必ずカバーする

## 重要タスクのロードマップ

1. **CLI ブートストラップ** - bin エントリ、tsconfig、実行可能ビルドの設定
2. **TDD セットアップ** - Vitest 設定とサンプルテスト
3. **Q CLI 検出** - バイナリ検出とプロセス起動
4. **TUI シェル** - Ink コンポーネントによる基本UI
5. **ストリームハンドリング** - ANSI/JSON/Markdown解析
6. **コマンドとフラグ** - 引数解析と検証
7. **設定とテレメトリ** - 設定管理
8. **E2Eテスト** - 統合のためのスモークテスト

## セキュリティ注意事項
- シークレットやAPIキーを絶対にコミットしない
- 機密設定には環境変数を使用
- すべてのサブプロセス入力を検証
- プロセスエラーを適切に処理