# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリで作業する際のガイダンスを提供します。

## プロジェクト概要

Qube は Amazon Q CLI のための Go ベースの TUI（ターミナルユーザーインターフェース）ラッパーで、Go と Bubble Tea フレームワークで構築されています。このプロジェクトは、コマンド履歴、出力ストリーミング、直感的なキーバインディングなどの機能を備えた、Amazon Q CLI のインタラクティブなシェル体験を提供することを目的としています。

## 主要コマンド

### 開発
- `go run cmd/qube/main.go` - 開発用実行
- `go build -o qube cmd/qube/main.go` - バイナリビルド
- `./qube` - コンパイル済みバイナリ実行
- `go test ./...` - テスト実行

### ビルドプロセス
1. Go コンパイル: `go build -o qube cmd/qube/main.go`
2. 出力: qube バイナリファイル（実行可能）
3. エントリポイント: cmd/qube/main.go

## アーキテクチャ

### 技術スタック
- **ランタイム**: Go 1.24.3+
- **UIフレームワーク**: Bubble Tea（ターミナルレンダリング用）
- **言語**: Go
- **ビルドツール**: go build

### プロジェクト構造
```
/
├── cmd/
│   └── qube/
│       └── main.go       # メインエントリポイント
├── internal/             # 内部パッケージ
│   ├── ui/              # UIモデル（Bubble Tea）
│   ├── execq/           # Q CLI実行機能
│   ├── executor/        # コマンド実行管理
│   ├── session/         # セッション管理
│   ├── stream/          # ストリーム処理
│   └── ...
├── tasks/               # 開発タスクドキュメント
├── go.mod              # Go module定義
└── qube                # ビルド済みバイナリ (gitignore対象)
```

### コアコンポーネント（実装済み）
1. **Q CLI 統合** (internal/execq)
   - バイナリ検出: 環境変数 > PATH検索
   - ストリーム処理を伴うプロセス起動
   - タイムアウトと非ゼロ終了のエラーハンドリング

2. **TUI シェル** (internal/ui)
   - Bubble Teaベースのインターフェース
   - スクロール可能な出力パネル
   - 履歴付きコマンド入力
   - ステータス表示
   - キーバインド: Enter（実行）、Ctrl+C（終了）、Ctrl+L（クリア）

3. **ストリーム処理** (internal/stream)
   - ANSIエスケープシーケンス処理
   - JSON/Markdown解析
   - リアルタイム出力レンダリング

## 開発ガイドライン

### 言語ポリシー
- **コードのコメントは日本語で記載すること**
- ドキュメント、テスト名、変数の説明は日本語を推奨
- コミットメッセージは英語推奨、日本語も可（チームで統一）
- PRには要点の簡潔な英訳を併記

### t-waga推奨のTDD実践方法

#### 基本原則
- **Red → Green → Refactor サイクルを徹底**
  1. Red: まず失敗するテストを書く
  2. Green: テストを通す最小限の実装を行う
  3. Refactor: コードを整理・改善する

#### 実践ルール
- **振る舞い駆動**: 外部挙動（入出力・副作用）をテストし、内部実装詳細に依存しない
- **優先順位**: プロセス間通信、例外系（`child_process.spawn`、タイムアウト、非ゼロ終了）を最優先でテスト
- **小さなステップ**: 各ステップで必ずコミット（テスト追加、実装、リファクタリングを分ける）
- **テスト名**: 仕様を短文で記述（日本語推奨）
  - 例: `「Q CLIが見つからない場合、分かりやすいエラーメッセージを表示する」`
  - 例: `「コマンド実行時、標準出力をUIに反映する」`

#### コミット例
```
test: Q CLIバイナリが存在しない場合のテストを追加 (Red)
feat: Q CLIバイナリ検出エラーメッセージを実装 (Green)
refactor: エラーメッセージ生成を関数に抽出 (Refactor)
```

### コードスタイル
- Go（標準的なGoスタイル）
- フォーマット: gofmt
- ファイル名: snake_case（Goの慣習）
- パッケージ: lowercase
- 関数/型: PascalCase（公開）、camelCase（非公開）
- 関数は小さく、単一責務を保つ

### テスト戦略
- フレームワーク: Go標準testing
- 配置: 同パッケージ内の *_test.go
- 外部依存はモック化
- 重要処理は ≥80% カバレッジを目標
- フォーカス: プロセス実行、ストリーム解析、エラーケース

### テスト作成時の注意点
- 各テストは独立して実行可能にする
- セットアップとクリーンアップを適切に行う
- モックは最小限に留め、可能な限り実際の動作に近いテストを書く
- エッジケースと異常系を必ずカバーする

## 実装状況

✅ **完了済み**
1. **Go移行** - TypeScript版からGo版への完全移行
2. **Q CLI検出** - バイナリ検出とプロセス起動 (internal/execq)
3. **TUIシェル** - Bubble Teaによる基本UI (internal/ui)  
4. **ストリーム処理** - ANSI/JSON/Markdown解析 (internal/stream)
5. **セッション管理** - 長時間セッションの管理 (internal/session)
6. **コマンド実行** - 短命・セッション型コマンド実行 (internal/executor)

🚧 **今後の拡張**
- 設定管理とテレメトリ
- 高度なキーバインディング
- E2Eテストの充実

## セキュリティ注意事項
- シークレットやAPIキーを絶対にコミットしない
- 機密設定には環境変数を使用
- すべてのサブプロセス入力を検証
- プロセスエラーを適切に処理